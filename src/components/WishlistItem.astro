---
import type { WishlistItem as Item } from "../types/database";
import DonationForm from "./DonationForm.astro";

const { item, enablePayPal = false } = Astro.props as { item: Item; enablePayPal?: boolean };
const progress = Math.min(100, Math.round((item.raised / item.goal) * 100));
const isFunded = item.status === 'funded';

// Calcular cuÃ¡nto falta para completar la meta
const remaining = Math.max(0, item.goal - item.raised);
const maxDonation = Math.ceil(remaining); // Redondear hacia arriba

// Usar la imagen de la BD o una imagen placeholder
const imageUrl = item.imageUrl || 'https://images.unsplash.com/photo-1548625149-fc4a29cf7092?w=400&h=300&fit=crop';
const imageAlt = item.imageAlt || item.name;
---

<article class={`rounded-xl border ${isFunded ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-white'} shadow-md hover:shadow-lg transition-all overflow-hidden relative`}>
  <!-- Badge de completado -->
  {isFunded && (
    <div class="absolute top-4 right-4 bg-green-600 text-white px-3 py-1 rounded-full text-sm font-semibold shadow-lg z-20">
      âœ“ Completado
    </div>
  )}

  <!-- Image clicable -->
  <a href={`/item/${item.id}`} class="block h-48 bg-gradient-to-br from-gray-100 to-gray-200 relative overflow-hidden group">
    <img 
      src={imageUrl}
      alt={imageAlt}
      class={`w-full h-full object-cover transition-transform group-hover:scale-105 ${isFunded ? 'opacity-75' : ''}`}
    />
  </a>
  
  <div class="p-5">
    <!-- Contenido clicable -->
    <a href={`/item/${item.id}`} class="block mb-4 hover:opacity-80 transition-opacity">
      <header>
        <h3 class={`text-xl font-bold ${isFunded ? 'text-green-900' : 'text-gray-900'}`}>{item.name}</h3>
        <p class={`mt-1 text-sm ${isFunded ? 'text-green-700' : 'text-gray-600'}`} style="white-space: pre-line;">{item.description}</p>
      </header>
    </a>

    <!-- Barra de progreso clicable -->
    <a href={`/item/${item.id}`} class="block mb-4 hover:opacity-80 transition-opacity">
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="text-gray-600 font-medium">{item.goal.toFixed(0)} â‚¬ Meta</span>
        <span class="text-gray-900 font-semibold">{progress}%</span>
      </div>
      <div class="h-2 w-full overflow-hidden rounded-full bg-gray-200">
        <div class={`h-full transition-all ${isFunded ? 'bg-green-500' : ''}`} style={isFunded ? { width: `${progress}%` } : { width: `${progress}%`, backgroundColor: 'var(--primary)' }} />
      </div>
      <p class={`mt-1 text-xs ${isFunded ? 'text-green-700 font-semibold' : 'text-gray-600'}`}>
        {item.raised.toFixed(0)} â‚¬ Recaudado
        {isFunded && ' ðŸŽ‰'}
      </p>
    </a>

    <!-- Zona de interacciÃ³n -->
    {enablePayPal && !isFunded && (
      <div class="-mx-5 -mb-5 px-5 pb-5 pt-4 bg-gray-50/50" style="position: static;">
        <DonationForm itemId={item.id} itemName={item.name} maxDonation={maxDonation} />
      </div>
    )}
    
    {isFunded && (
      <div class="mt-4 text-center relative -mx-5 -mb-5 px-5 pb-5">
        <p class="text-green-700 font-semibold text-sm">
          Â¡Gracias a todos los que contribuyeron!
        </p>
        <p class="text-green-600 text-xs mt-1">
          Este artÃ­culo ya ha alcanzado su meta de financiaciÃ³n.
        </p>
      </div>
    )}
  </div>
</article>
